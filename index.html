<!DOCTYPE html>
<html lang="vi" translate="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="google" content="notranslate">
<title>Anki CSV Builder (JP-EN) ‚Äî v2 fixed</title>
<style>
  :root { --pad: 16px; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial, sans-serif; margin: var(--pad); }
  h1 { font-size: 22px; margin: 0 0 8px; }
  .hint { color:#555; font-size:14px; margin-bottom: 12px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 8px 0; }
  .btn { padding:12px 16px; border:1px solid #ccc; border-radius:10px; background:#f4f4f6; cursor:pointer; font-size:16px; }
  .btn.primary { background:#0b5fff; border-color:#0b5fff; color:#fff; }
  .btn:active { transform: translateY(1px); }
  textarea { width:100%; height:50vh; padding:12px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:15px; line-height:1.5; border:1px solid #ddd; border-radius:10px; }
  label { font-size:15px; }
  .status { margin-top:8px; font-size:14px; color:#444; }
  table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
  th, td { border:1px solid #eee; padding:8px; vertical-align: top; }
  th { background:#fafafa; text-align:left; }
  .notranslate{ translate: no; }
  @media (min-width: 900px){
    textarea{ height: 45vh; }
  }
</style>
</head>
<body>
  <h1>Anki CSV Builder (JP-EN)</h1>
  <div class="hint">
    Xu·∫•t CSV <b>7 c·ªôt, kh√¥ng header</b> theo map c·ªë ƒë·ªãnh:<br>
    <code>1) JP | 2) Analysis | 3) Key | 4) Word | 5) (empty) | 6) Meaning | 7) EN</code><br>
    B·ªè qua: <code>üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ</code>, <code>üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã</code>.  
    C·∫Øt block theo: <code>=== Word #...</code> ho·∫∑c <code>üìñ Ëã±ÂçòË™û</code> ho·∫∑c <code>[Êó•Êú¨Ë™ûÊñá]</code> (ƒë·ªÉ input c·ªßa b·∫°n kh√¥ng b·ªã d√≠nh block).
  </div>

  <div class="row">
    <button class="btn" id="btnExample">D√°n v√≠ d·ª•</button>
    <button class="btn primary" id="btnDownload">T·∫£i CSV</button>
    <label><input type="checkbox" id="chkDedup" checked> Lo·∫°i tr√πng theo Sentence (JP)</label>
  </div>

  <textarea id="input" placeholder="D√°n input theo format b·∫°n ƒë√£ g·ª≠i (c√≥ === Word #... ===, ‚∏ª, v.v.)"></textarea>

  <div class="row">
    <button class="btn" id="btnPreview">Preview</button>
    <span class="status" id="status">S·ªë th·∫ª h·ª£p l·ªá: 0</span>
  </div>

  <div id="preview" class="notranslate"></div>

<script>
function normalize(text){ return (text||"").trim().replace(/\r\n/g,"\n").replace(/\r/g,"\n"); }

// --- C·∫ÆT BLOCK: m·ªü block khi g·∫∑p "=== Word", ho·∫∑c üìñ Ëã±ÂçòË™û, ho·∫∑c [Êó•Êú¨Ë™ûÊñá]
function splitBlocks(t){
  // d√πng m flag ƒë·ªÉ ^ kh·ªõp ƒë·∫ßu d√≤ng
  return t.split(/\n(?=(?:===\s*Word\s*#|\s*üìñ\s*Ëã±ÂçòË™û|\s*\[Êó•Êú¨Ë™ûÊñá\]))/m).filter(Boolean);
}

function parseBlocks(text){
  const t = normalize(text);
  if(!t) return [];
  const parts = splitBlocks(t);
  const rows = [];
  for(const part of parts){
    // regex c√πng-d√≤ng, ƒë√∫ng phong c√°ch code c≈©
    const mWORD = part.match(/üìñ\s*Ëã±ÂçòË™û\s*[:Ôºö]?\s*(.+)/);
    const mMEAN = part.match(/ÊÑèÂë≥\s*[:Ôºö]?\s*(.+)/);
    const mJP   = part.match(/\[Êó•Êú¨Ë™ûÊñá\]\s*(.+)/);
    const mEN   = part.match(/\[Ëã±Ë™ûÊñá\]\s*(.+)/);
    const mAN   = part.match(/üîé\s*ÊñáËß£Êûê\s*[:Ôºö]?\s*(.+)/);
    const mKEY  = part.match(/üìå\s*„Ç≠„Éº„Éï„É¨„Éº„Ç∫\s*[:Ôºö]?\s*(.+)/);
    // B·ªé QUA: ÁîªÂÉè/„Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥

    const word = mWORD ? mWORD[1].trim() : "";
    const mean = mMEAN ? mMEAN[1].trim() : "";
    const jp   = mJP   ? mJP[1].trim()   : "";
    const en   = mEN   ? mEN[1].trim()   : "";
    const an   = mAN   ? mAN[1].trim()   : "";
    const key  = mKEY  ? mKEY[1].trim()  : "";

    // √©p ƒë·ªß b·ªô ƒë·ªÉ tr√°nh h√†ng sai map
    if(jp && en && word && mean){
      // Map v2: 1) JP | 2) Analysis | 3) Key | 4) Word | 5) (empty) | 6) Meaning | 7) EN
      rows.push([jp, an, key, word, "", mean, en]);
    }
  }
  return rows;
}

function toCSVNoHeader(rows){
  const escape = (v) => {
    const s = String(v ?? "");
    const need = /[",\n]/.test(s);
    const e = s.replace(/"/g, '""');
    return need ? `"${e}"` : e;
  };
  return rows.map(r => r.map(escape).join(",")).join("\n");
}

function setStatus(msg){ document.getElementById("status").textContent = msg; }

function renderPreview(rows){
  const el = document.getElementById("preview");
  if(rows.length===0){ el.innerHTML=""; return; }

  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>JP</th>
      <th>Analysis</th>
      <th>Key</th>
      <th>Word</th>
      <th>(empty)</th>
      <th>Meaning</th>
      <th>EN</th>
    </tr>`;

  rows.slice(0,10).forEach(r=>{
    const tr = document.createElement("tr");
    r.forEach(c=>{
      const td = document.createElement("td");
      td.textContent = c || ""; // tr√°nh &quot; ·ªü preview
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });

  el.innerHTML = "";
  el.appendChild(table);
  const info = document.createElement("div");
  info.className = "status";
  info.textContent = `Hi·ªÉn th·ªã t·ªëi ƒëa 10 d√≤ng xem tr∆∞·ªõc ‚Ä¢ T·ªïng: ${rows.length}`;
  el.appendChild(info);
}

function downloadCSV(filename, csvText){
  const blob = new Blob(["\uFEFF"+csvText], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
}

// --- v√≠ d·ª• ƒë√∫ng theo INPUT b·∫°n g·ª≠i
const EXAMPLE = `=== Word #1 ===

üìñ Ëã±ÂçòË™û: borrow
ÊÑèÂë≥: ÂÄü„Çä„ÇãÔºà„ÅäÈáë„ÇÑÁâ©„Çí‰∫∫„Åã„Çâ‰∏ÄÊôÇÁöÑ„Å´Âèó„ÅëÂèñ„ÇãÔºâ

[Êó•Êú¨Ë™ûÊñá]
Êò®Êó•„ÄÅÂΩº„Åã„Çâ„ÅäÈáë„ÇíÂ∞ë„ÅóÂÄü„Çä„Åæ„Åó„Åü„ÄÇ
[Ëã±Ë™ûÊñá]
I borrowed some money from him yesterday.

üìå „Ç≠„Éº„Éï„É¨„Éº„Ç∫:üí° :: „Äåborrow A from B„Äç„Åß„ÄåB„Åã„ÇâA„ÇíÂÄü„Çä„Çã„Äç„ÄÇÂèçÂØæ„ÅÆ„Äålend„Äç„ÅØ„ÄåA„ÇíB„Å´Ë≤∏„Åô„Äç„ÄÇ
üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ: wallet, cash, friend, lending, coins
üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã: borrow money, borrow a book, borrow time

‚∏ª

=== Word #2 ===

üìñ Ëã±ÂçòË™û: invite
ÊÑèÂë≥: ÊãõÂæÖ„Åô„ÇãÔºà‰∫∫„ÇíÈ£ü‰∫ã„Éª„Ç§„Éô„É≥„Éà„Å™„Å©„Å´Âëº„Å∂Ôºâ

[Êó•Êú¨Ë™ûÊñá]
ÂΩº„ÅØÁßÅ„ÇíÂΩº„ÅÆË™ïÁîüÊó•„Éë„Éº„ÉÜ„Ç£„Éº„Å´ÊãõÂæÖ„Åó„Åæ„Åó„Åü„ÄÇ
[Ëã±Ë™ûÊñá]
He invited me to his birthday party.

üìå „Ç≠„Éº„Éï„É¨„Éº„Ç∫:üí° :: „Äåinvite ‰∫∫ to Â†¥ÊâÄÔºè„Ç§„Éô„É≥„Éà„ÄçÊßãÊñá„ÄÇ„Äåinvite for„Äç„ÅØ‰Ωø„Çè„Å™„ÅÑÔºÅ
üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ: birthday party, friends, balloons, cake, invitation card
üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã: invite someone to dinner, invite guests, invite friends

‚∏ª

=== Word #3 ===

üìñ Ëã±ÂçòË™û: decide
ÊÑèÂë≥: Ê±∫„ÇÅ„ÇãÔºàÈÅ∏ÊäûËÇ¢„ÅÆ‰∏≠„Åã„Çâ‰Ωï„Åã„ÇíÈÅ∏„Å∂Ôºâ

[Êó•Êú¨Ë™ûÊñá]
ÁßÅ„ÅØ„Å©„ÅÆÂ§ßÂ≠¶„Å´Ë°å„Åè„ÅãÊ±∫„ÇÅ„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì„ÄÇ
[Ëã±Ë™ûÊñá]
I have to decide which university to go to.

üìå „Ç≠„Éº„Éï„É¨„Éº„Ç∫:üí° :: „Äådecide to ÂãïË©û„ÄçÔºù„Äå„Äú„Åô„Çã„Åì„Å®„ÇíÊ±∫„ÇÅ„Çã„Äç„ÄÇ„Äådecide on ÂêçË©û„Äç„ÇÇ„Çà„Åè‰Ωø„ÅÜ„ÄÇ
üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ: university, student, decision, thinking, future
üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã: decide to go, decide on a plan, decide quickly`;

const $input = document.getElementById("input");
const $chk = document.getElementById("chkDedup");

function currentRows(){
  let rows = parseBlocks($input.value);
  if($chk.checked){
    const seen = new Set();
    rows = rows.filter(r=>{
      if(seen.has(r[0])) return false; // r[0] = JP
      seen.add(r[0]); return true;
    });
  }
  return rows;
}

document.getElementById("btnExample").addEventListener("click", ()=>{
  $input.value = EXAMPLE;
  const rows = currentRows();
  setStatus(`S·ªë th·∫ª h·ª£p l·ªá: ${rows.length}`);
  renderPreview(rows);
});

document.getElementById("btnPreview").addEventListener("click", ()=>{
  const rows = currentRows();
  if(rows.length===0){
    alert("Ch∆∞a t√¨m th·∫•y th·∫ª h·ª£p l·ªá. M·ªói block c·∫ßn c√≥: Ëã±ÂçòË™û / ÊÑèÂë≥ / [Êó•Êú¨Ë™ûÊñá] / [Ëã±Ë™ûÊñá].");
  }
  setStatus(`S·ªë th·∫ª h·ª£p l·ªá: ${rows.length}`);
  renderPreview(rows);
});

document.getElementById("btnDownload").addEventListener("click", ()=>{
  const rows = currentRows();
  if(rows.length===0){
    alert("Kh√¥ng c√≥ th·∫ª h·ª£p l·ªá ƒë·ªÉ xu·∫•t.");
    return;
  }
  const csv = toCSVNoHeader(rows);
  downloadCSV("anki_cards_v2.csv", csv);
});

// c·∫≠p nh·∫≠t ƒë·∫øm nhanh khi nh·∫≠p
$input.addEventListener("input", ()=>{
  const rows = currentRows();
  setStatus(`S·ªë th·∫ª h·ª£p l·ªá: ${rows.length}`);
});
</script>
</body>
</html>