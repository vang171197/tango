<!DOCTYPE html>
<html lang="vi" translate="no">
<head>
<meta charset="utf-8">
<meta name="google" content="notranslate">
<title>Anki CSV Builder (JP-EN v3)</title>
<style>
body{font-family:system-ui,sans-serif;margin:20px;}
h2{margin-bottom:4px;}
textarea{width:100%;height:50vh;font-family:ui-monospace,monospace;font-size:15px;padding:10px;}
button{padding:10px 16px;margin:10px 6px 10px 0;font-size:16px;}
.status{font-size:14px;color:#333;margin-top:6px;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;}
th,td{border:1px solid #ddd;padding:6px 8px;vertical-align:top;}
th{background:#f5f5f5;}
</style>
</head>
<body>
<h2>Anki CSV Builder (JP-EN)</h2>
<p>Map c·ªë ƒë·ªãnh: <b>1) JP | 2) Analysis | 3) Key | 4) Word | 5) (empty) | 6) Meaning | 7) EN</b><br>
B·ªè qua: üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ, üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã1</p>

<button id="btnExample">üìã D√°n v√≠ d·ª•</button>
<button id="btnPreview">üîç Preview</button>
<button id="btnDownload">üíæ T·∫£i CSV</button>
<label><input type="checkbox" id="chkDedup" checked> Lo·∫°i tr√πng theo JP</label>
<div class="status" id="status">S·ªë th·∫ª h·ª£p l·ªá: 0</div>

<textarea id="input" placeholder="D√°n n·ªôi dung theo format === Word #... === t·∫°i ƒë√¢y..."></textarea>
<div id="preview"></div>

<script>
function normalize(t){return (t||"").trim().replace(/\r\n/g,"\n").replace(/\r/g,"\n");}

// --- c·∫Øt block: ch·ªâ theo === Word #... === ho·∫∑c üìñ Ëã±ÂçòË™û ---
function splitBlocks(t){
  return t.split(/\n(?=(?:===\s*Word\s*#|üìñ\s*Ëã±ÂçòË™û))/m).filter(Boolean);
}

function parseBlocks(t){
  const parts = splitBlocks(normalize(t));
  const rows = [];

  // l·∫•y 1 d√≤ng sau m·ªôt "header" (header ·ªü 1 d√≤ng ri√™ng)
  function nextLineAfter(block, headerRe){
    const m = block.match(new RegExp(headerRe.source + String.raw`\s*\n\s*([^\n]+)`, headerRe.flags));
    return (m && m[1]) ? m[1].trim() : "";
  }

  // l·∫•y value sau nh√£n tr√™n c√πng 1 d√≤ng: "Label: value"
  function inlineAfter(block, labelRe){
    const m = block.match(new RegExp(labelRe.source + String.raw`\s*[:Ôºö]\s*([^\n]+)`, labelRe.flags));
    return (m && m[1]) ? m[1].trim() : "";
  }

  for (const p of parts){
    // üìñ T·ª´ v·ª±ng ti·∫øng Anh: worry :: /.../ :: ...
    // -> l·∫•y "worry" (ph·∫ßn tr∆∞·ªõc ::)
    let wordLine = inlineAfter(p, /üìñ\s*T·ª´ v·ª±ng ti·∫øng Anh/i);
    let word = "";
    let wordExtra = "";
    if (wordLine){
      const segs = wordLine.split("::").map(s => s.trim()).filter(Boolean);
      word = segs[0] || "";
      // ph·∫ßn c√≤n l·∫°i (IPA/romaji ki·ªÉu VN) ƒë∆∞a v√†o analysis cho ti·ªán tra l·∫°i
      wordExtra = segs.slice(1).join(" :: ");
    }

    // Nghƒ©a: lo l·∫Øng
    const mean = inlineAfter(p, /Nghƒ©a/i);

    // VN / EN: c√¢u n·∫±m ·ªü d√≤ng k·∫ø ti·∫øp
    const vn = nextLineAfter(p, /\[üáªüá≥\s*C√¢u ti·∫øng Vi·ªát\]/);
    let enLine = nextLineAfter(p, /\[üá∫üá∏\s*C√¢u ti·∫øng Anh\]/);

    // EN c√≥ th·ªÉ c√≥ ":: phi√™n √¢m" -> t√°ch ra
    let en = "";
    let enPron = "";
    if (enLine){
      const segs = enLine.split("::").map(s => s.trim());
      en = segs[0] || "";
      enPron = segs.slice(1).join(" :: ").trim();
    }

    // Key phrase: "üìå Key phrase üí° :: ..."
    // ch·∫•p nh·∫≠n c√≥/kh√¥ng üí°, c√≥/kh√¥ng ::
    let key = "";
    const keyM = p.match(/üìå\s*Key phrase(?:\s*üí°)?\s*(?:::\s*|[:Ôºö]\s*)?([^\n]+)/i);
    if (keyM && keyM[1]) key = keyM[1].trim();

    // Analysis: gom phi√™n √¢m t·ª´ d√≤ng word + phi√™n √¢m EN (n·∫øu c√≥)
    // (B·∫°n c√≥ th·ªÉ ƒë·ªïi √Ω: nh√©t enPron v√†o Key c≈©ng ƒë∆∞·ª£c, nh∆∞ng analysis h·ª£p l√Ω h∆°n)
    let an = [wordExtra, enPron].filter(Boolean).join(" | ");

    // Map c·ªë ƒë·ªãnh c≈©: 1) JP | 2) Analysis | 3) Key | 4) Word | 5) empty | 6) Meaning | 7) EN
    // V·ªõi format m·ªõi: c·ªôt 1 s·∫Ω l√† VN
    if (vn && en && word && mean){
      rows.push([vn, an, key, word, "", mean, en]);
    }
  }

  return rows;
}


function toCSV(rows){
  const esc=v=>/["\n,]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}

function renderPreview(rows){
  const el=document.getElementById("preview");
  if(!rows.length){el.innerHTML="";return;}
  let html="<table><tr><th>JP</th><th>Analysis</th><th>Key</th><th>Word</th><th>(empty)</th><th>Meaning</th><th>EN</th></tr>";
  for(const r of rows.slice(0,10)){
    html+="<tr>"+r.map(c=>`<td>${c?c.replace(/&/g,"&amp;").replace(/</g,"&lt;"):""}</td>`).join("")+"</tr>";
  }
  html+="</table><div class='status'>Hi·ªÉn th·ªã t·ªëi ƒëa 10 d√≤ng xem tr∆∞·ªõc ‚Ä¢ T·ªïng: "+rows.length+"</div>";
  el.innerHTML=html;
}

function setStatus(msg){document.getElementById("status").textContent=msg;}

function currentRows(){
  let rows=parseBlocks(document.getElementById("input").value);
  if(document.getElementById("chkDedup").checked){
    const seen=new Set();
    rows=rows.filter(r=>{
      if(seen.has(r[0]))return false;
      seen.add(r[0]);
      return true;
    });
  }
  return rows;
}

// --- v√≠ d·ª• m·∫´u ---
const EXAMPLE=`=== Word #1 ===

üìñ Ëã±ÂçòË™û: borrow
ÊÑèÂë≥: ÂÄü„Çä„ÇãÔºà„ÅäÈáë„ÇÑÁâ©„Çí‰∫∫„Åã„Çâ‰∏ÄÊôÇÁöÑ„Å´Âèó„ÅëÂèñ„ÇãÔºâ

[Êó•Êú¨Ë™ûÊñá]
Êò®Êó•„ÄÅÂΩº„Åã„Çâ„ÅäÈáë„ÇíÂ∞ë„ÅóÂÄü„Çä„Åæ„Åó„Åü„ÄÇ
[Ëã±Ë™ûÊñá]
I borrowed some money from him yesterday.

üìå „Ç≠„Éº„Éï„É¨„Éº„Ç∫:üí° :: „Äåborrow A from B„Äç„Åß„ÄåB„Åã„ÇâA„ÇíÂÄü„Çä„Çã„Äç„ÄÇÂèçÂØæ„ÅÆ„Äålend„Äç„ÅØ„ÄåA„ÇíB„Å´Ë≤∏„Åô„Äç„ÄÇ
üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ: wallet, cash, friend, lending, coins
üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã: borrow money, borrow a book, borrow time

‚∏ª

=== Word #2 ===

üìñ Ëã±ÂçòË™û: invite
ÊÑèÂë≥: ÊãõÂæÖ„Åô„ÇãÔºà‰∫∫„ÇíÈ£ü‰∫ã„Éª„Ç§„Éô„É≥„Éà„Å™„Å©„Å´Âëº„Å∂Ôºâ

[Êó•Êú¨Ë™ûÊñá]
ÂΩº„ÅØÁßÅ„ÇíÂΩº„ÅÆË™ïÁîüÊó•„Éë„Éº„ÉÜ„Ç£„Éº„Å´ÊãõÂæÖ„Åó„Åæ„Åó„Åü„ÄÇ
[Ëã±Ë™ûÊñá]
He invited me to his birthday party.

üìå „Ç≠„Éº„Éï„É¨„Éº„Ç∫:üí° :: „Äåinvite ‰∫∫ to Â†¥ÊâÄÔºè„Ç§„Éô„É≥„Éà„ÄçÊßãÊñá„ÄÇ„Äåinvite for„Äç„ÅØ‰Ωø„Çè„Å™„ÅÑÔºÅ
üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ: birthday party, friends, balloons, cake, invitation card
üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã: invite someone to dinner, invite guests, invite friends

‚∏ª

=== Word #3 ===

üìñ Ëã±ÂçòË™û: decide
ÊÑèÂë≥: Ê±∫„ÇÅ„ÇãÔºàÈÅ∏ÊäûËÇ¢„ÅÆ‰∏≠„Åã„Çâ‰Ωï„Åã„ÇíÈÅ∏„Å∂Ôºâ

[Êó•Êú¨Ë™ûÊñá]
ÁßÅ„ÅØ„Å©„ÅÆÂ§ßÂ≠¶„Å´Ë°å„Åè„ÅãÊ±∫„ÇÅ„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì„ÄÇ
[Ëã±Ë™ûÊñá]
I have to decide which university to go to.

üìå „Ç≠„Éº„Éï„É¨„Éº„Ç∫:üí° :: „Äådecide to ÂãïË©û„ÄçÔºù„Äå„Äú„Åô„Çã„Åì„Å®„ÇíÊ±∫„ÇÅ„Çã„Äç„ÄÇ„Äådecide on ÂêçË©û„Äç„ÇÇ„Çà„Åè‰Ωø„ÅÜ„ÄÇ
üñº ÁîªÂÉè„Ç≠„Éº„ÉØ„Éº„Éâ: university, student, decision, thinking, future
üß© „Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥‰æã: decide to go, decide on a plan, decide quickly`;

document.getElementById("btnExample").onclick=()=>{
  document.getElementById("input").value=EXAMPLE;
  const rows=currentRows();
  setStatus("S·ªë th·∫ª h·ª£p l·ªá: "+rows.length);
  renderPreview(rows);
};

document.getElementById("btnPreview").onclick=()=>{
  const rows=currentRows();
  setStatus("S·ªë th·∫ª h·ª£p l·ªá: "+rows.length);
  renderPreview(rows);
};

document.getElementById("btnDownload").onclick=()=>{
  const rows=currentRows();
  if(!rows.length){alert("Kh√¥ng c√≥ th·∫ª h·ª£p l·ªá ƒë·ªÉ xu·∫•t.");return;}
  const csv="\uFEFF"+toCSV(rows);
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="anki_cards.csv";
  a.click();
};
</script>
</body>
</html>
