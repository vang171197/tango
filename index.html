<!DOCTYPE html>
<html lang="vi" translate="no">
<head>
<meta charset="utf-8">
<meta name="google" content="notranslate">
<title>Anki CSV Builder (JP-EN)</title>
</head>
<body>
<textarea id="input" style="width:100%;height:50vh;"></textarea>
<button id="run">Táº£i CSV</button>
<script>
function normalize(t){return (t||"").trim().replace(/\r\n/g,"\n").replace(/\r/g,"\n")}
function splitBlocks(t){
  // chá»‰ má»Ÿ block á»Ÿ === Word... hoáº·c ðŸ“– è‹±å˜èªž
  return t.split(/\n(?=(?:===\s*Word\s*#|\s*ðŸ“–\s*è‹±å˜èªž))/m).filter(Boolean)
}
function parseBlocks(t){
  const parts=splitBlocks(normalize(t)),rows=[]
  for(const p of parts){
    const jp=(p.match(/\[æ—¥æœ¬èªžæ–‡\]\s*(.+)/)||[])[1]||""
    const en=(p.match(/\[è‹±èªžæ–‡\]\s*(.+)/)||[])[1]||""
    const key=(p.match(/ðŸ“Œ\s*ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º\s*[:ï¼š]?\s*(.+)/)||[])[1]||""
    const word=(p.match(/ðŸ“–\s*è‹±å˜èªž\s*[:ï¼š]?\s*(.+)/)||[])[1]||""
    const mean=(p.match(/æ„å‘³\s*[:ï¼š]?\s*(.+)/)||[])[1]||""
    const an=(p.match(/ðŸ”Ž\s*æ–‡è§£æž\s*[:ï¼š]?\s*(.+)/)||[])[1]||""
    if(jp&&en&&word&&mean)
      rows.push([jp.trim(),an.trim(),key.trim(),word.trim(),"",mean.trim(),en.trim()])
  }
  return rows
}
function toCSV(rows){
  const esc=v=>/["\n,]/.test(v)?`"${v.replace(/"/g,'""')}"`:v
  return rows.map(r=>r.map(esc).join(",")).join("\n")
}
document.getElementById("run").onclick=()=>{
  const txt=document.getElementById("input").value
  const csv="\uFEFF"+toCSV(parseBlocks(txt))
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"})
  const a=document.createElement("a")
  a.href=URL.createObjectURL(blob)
  a.download="anki_cards.csv"
  a.click()
}
</script>
</body>
</html>