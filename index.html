<!DOCTYPE html>
<html lang="vi" translate="no">
<head>
<meta charset="utf-8">
<meta name="google" content="notranslate">
<title>Anki CSV Builder (JP-EN)</title>
<style>
body { font-family: system-ui, sans-serif; margin:20px; }
textarea { width:100%; height:50vh; font-family: ui-monospace, monospace; font-size:15px; }
button { padding:10px 16px; margin:10px 5px 20px 0; font-size:16px; }
</style>
</head>
<body>
<h2>Anki CSV Builder (JP-EN)</h2>
<p>Map cá»‘ Ä‘á»‹nh: 1) JP | 2) Analysis | 3) Key | 4) Word | 5) (empty) | 6) Meaning | 7) EN</p>

<textarea id="input" placeholder="DÃ¡n dá»¯ liá»‡u táº¡i Ä‘Ã¢y..."></textarea><br>
<button id="run">Táº£i CSV</button>

<script>
function normalize(t){return (t||"").trim().replace(/\r\n/g,"\n").replace(/\r/g,"\n");}

// --- Chia block theo === Word #... === hoáº·c ðŸ“– è‹±å˜èªž ---
function splitBlocks(t){
  return t.split(/\n(?=(?:===\s*Word\s*#|ðŸ“–\s*è‹±å˜èªž))/m).filter(Boolean);
}

// --- PhÃ¢n tÃ­ch tá»«ng block ---
function parseBlocks(t){
  const parts = splitBlocks(normalize(t));
  const rows = [];
  for(const p of parts){
    const word = (p.match(/ðŸ“–\s*è‹±å˜èªž\s*[:ï¼š]?\s*(.+)/)||[])[1] || "";
    const mean = (p.match(/æ„å‘³\s*[:ï¼š]?\s*(.+)/)||[])[1] || "";
    const jp   = (p.match(/\[æ—¥æœ¬èªžæ–‡\]\s*(.+)/)||[])[1] || "";
    const en   = (p.match(/\[è‹±èªžæ–‡\]\s*(.+)/)||[])[1] || "";
    const an   = (p.match(/ðŸ”Ž\s*æ–‡è§£æž\s*[:ï¼š]?\s*(.+)/)||[])[1] || "";
    const key  = (p.match(/ðŸ“Œ\s*ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º\s*[:ï¼š]?\s*(.+)/)||[])[1] || "";
    // bá» qua áº£nh vÃ  collocation

    if(jp && en && word && mean){
      // map: 1) JP | 2) Analysis | 3) Key | 4) Word | 5) empty | 6) Meaning | 7) EN
      rows.push([jp.trim(), an.trim(), key.trim(), word.trim(), "", mean.trim(), en.trim()]);
    }
  }
  return rows;
}

// --- Xuáº¥t CSV ---
function toCSV(rows){
  const esc=v=>/["\n,]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}

document.getElementById("run").onclick=()=>{
  const txt=document.getElementById("input").value;
  const rows=parseBlocks(txt);
  if(!rows.length){alert("KhÃ´ng tÃ¬m tháº¥y tháº» há»£p lá»‡.");return;}
  const csv="\uFEFF"+toCSV(rows);
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="anki_cards.csv";
  a.click();
};
</script>
</body>
</html>